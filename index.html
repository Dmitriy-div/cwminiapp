<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CW CRM Master Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --bg: #f2f2f7; 
            --accent: #5856d6; 
            --card: #ffffff; 
            --text: #1c1c1e; 
            --secondary: #8e8e93; 
            --radius: 20px; 
            --green: #34c759; 
            --red: #ff3b30; 
            --orange: #ff9500;
        }
        
        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: 110px; 
            padding-top: env(safe-area-inset-top); /* –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–Ω–æ–ø–æ–∫ TG */
        }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ö–µ–¥–µ—Ä */
        .header { 
            background: #1c1c1e; 
            color: white; 
            padding: 40px 20px 25px; /* –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
            border-radius: 0 0 30px 30px; 
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .balance-val { font-size: 32px; font-weight: 800; margin-top: 5px; color: #fff; }

        /* –ü–æ–∏—Å–∫ –∏ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ */
        .search-row {
            display: flex;
            gap: 10px;
            padding: 15px 15px 5px;
            align-items: center;
        }
        .search-input {
            flex: 1;
            background: var(--card);
            border: none;
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
        }
        .sort-toggle {
            background: var(--card);
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sort-toggle.active { color: var(--accent); }

        .filter-bar { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; scrollbar-width: none; }
        .chip { padding: 8px 16px; background: white; border-radius: 20px; font-size: 13px; color: var(--secondary); white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chip.active { background: var(--accent); color: white; font-weight: bold; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ */
        .card { background: var(--card); margin: 0 15px 12px; padding: 16px; border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border-left: 4px solid transparent; transition: 0.3s; }
        .card.deadline-urgent { border-left-color: var(--red); background: #fff8f8; }
        .card.deadline-warning { border-left-color: var(--orange); }
        
        .card-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pay-btn { font-size: 11px; padding: 6px 12px; border-radius: 10px; border: none; font-weight: bold; }
        .pay-done { background: #34c75920; color: #34c759; }
        .pay-wait { background: #ff3b3020; color: #ff3b30; }

        /* –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∞–∑–∞ */
        .client-card { display: flex; align-items: center; gap: 12px; padding: 15px; background: white; margin: 0 15px 10px; border-radius: 15px; }
        .client-avatar { width: 40px; height: 40px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); display: flex; padding: 10px 0 30px; border-top: 0.5px solid #ddd; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--secondary); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--accent); }
        
        .add-btn { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(88,86,214,0.4); z-index: 999; border: none; }
        
        .modal-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 30px 30px 0 0; padding: 25px; transform: translateY(100%); transition: 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); z-index: 2000; box-sizing: border-box; }
        .modal-sheet.active { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1999; backdrop-filter: blur(2px); }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .input-pill { width: 100%; background: #f2f2f7; border: none; padding: 14px; border-radius: 12px; margin-bottom: 12px; font-size: 16px; outline: none; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="toast" class="toast" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#333; color:white; padding:10px 20px; border-radius:20px; z-index:9999;"></div>

    <div class="header">
        <div style="font-size: 11px; opacity: 0.6; letter-spacing: 1px;">–ü–†–ò–ë–´–õ–¨ –ú–ê–°–¢–ï–†–°–ö–û–ô</div>
        <div class="balance-val"><span id="totalBalance">0.00</span> BYN</div>
    </div>

    <div id="search-section">
        <div class="search-row">
            <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É –∏–ª–∏ —Ç–æ–≤–∞—Ä—É..." oninput="renderOrders()">
            <button class="sort-toggle" id="sortBtn" onclick="toggleSort()">
                <i data-lucide="arrow-up-down"></i>
            </button>
        </div>
        <div class="filter-bar">
            <div class="chip active" onclick="setFilter('–í—Å–µ', this)">–í—Å–µ</div>
            <div class="chip" onclick="setFilter('–ù–æ–≤—ã–π', this)">–ù–æ–≤—ã–µ</div>
            <div class="chip" onclick="setFilter('–í —Ä–∞–±–æ—Ç–µ', this)">–í —Ä–∞–±–æ—Ç–µ</div>
            <div class="chip" onclick="setFilter('–ì–æ—Ç–æ–≤', this)">–ì–æ—Ç–æ–≤—ã</div>
        </div>
    </div>

    <div id="app-content"></div>

    <button class="add-btn" id="mainAddBtn" onclick="openModal()"><i data-lucide="plus"></i></button>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orders', this)"><i data-lucide="package"></i><span>–ó–∞–∫–∞–∑—ã</span></div>
        <div class="nav-item" onclick="switchTab('clients', this)"><i data-lucide="users"></i><span>–ö–ª–∏–µ–Ω—Ç—ã</span></div>
        <div class="nav-item" onclick="switchTab('shipments', this)"><i data-lucide="truck"></i><span>–û—Ç–ø—Ä–∞–≤–∫–∏</span></div>
        <div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="pie-chart"></i><span>–ë—é–¥–∂–µ—Ç</span></div>
    </nav>

    <div id="overlay" class="overlay" onclick="closeModals()"></div>

    <div id="orderModal" class="modal-sheet">
        <h3 id="modalTitle">–ó–∞–∫–∞–∑</h3>
        <input type="hidden" id="editOrderId">
        <input type="text" id="ordNick" class="input-pill" placeholder="–ù–∏–∫ Instagram">
        <select id="ordItem" class="input-pill">
            <option value="–ë—Ä–æ—à—å">–ë—Ä–æ—à—å</option>
            <option value="–ë—Ä–µ–ª–æ–∫">–ë—Ä–µ–ª–æ–∫</option>
            <option value="–ú–∞–≥–Ω–∏—Ç">–ú–∞–≥–Ω–∏—Ç</option>
        </select>
        <input type="number" id="ordPrice" class="input-pill" placeholder="–¶–µ–Ω–∞ (BYN)">
        <input type="date" id="ordDeadline" class="input-pill">
        <button onclick="saveOrder()" class="input-pill" style="background:var(--accent); color:white; font-weight:bold;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

<script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxOT8-6WetxBFq-zp22OwZ1QLcCvdLPbV819yK7uQifvMW2-r9EJ6RF_UjOFQDYeGob/exec"; 
    const tg = window.Telegram.WebApp;
    let currentTab = 'orders', currentFilter = '–í—Å–µ', appData = null, sortByDeadline = false;

    function init() { 
        tg.ready(); 
        tg.expand(); 
        loadData(); 
    }

    async function loadData() {
        try {
            const res = await fetch(SHEET_URL);
            appData = await res.json();
            renderCurrentTab();
        } catch(e) { console.error(e); }
    }

    function toggleSort() {
        sortByDeadline = !sortByDeadline;
        document.getElementById('sortBtn').classList.toggle('active');
        tg.HapticFeedback.impactOccurred('light');
        renderOrders();
    }

    function renderOrders() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        let filtered = appData.orders.filter(o => {
            const matchFilter = currentFilter === '–í—Å–µ' || o.–°—Ç–∞—Ç—É—Å === currentFilter;
            const matchSearch = o['–ù–∏–∫ Instagram'].toLowerCase().includes(query) || o['–¢–∏–ø –∏–∑–¥–µ–ª–∏—è'].toLowerCase().includes(query);
            return matchFilter && matchSearch;
        });

        if (sortByDeadline) {
            filtered.sort((a, b) => new Date(a.–î–µ–¥–ª–∞–π–Ω || '9999') - new Date(b.–î–µ–¥–ª–∞–π–Ω || '9999'));
        } else {
            filtered.reverse();
        }

        let html = '';
        const now = new Date();
        now.setHours(0,0,0,0);

        filtered.forEach(o => {
            let deadlineClass = '';
            if (o.–î–µ–¥–ª–∞–π–Ω && o.–°—Ç–∞—Ç—É—Å !== '–ì–æ—Ç–æ–≤') {
                const dDate = new Date(o.–î–µ–¥–ª–∞–π–Ω);
                const diff = (dDate - now) / (1000 * 60 * 60 * 24);
                if (diff <= 0) deadlineClass = 'deadline-urgent';
                else if (diff <= 3) deadlineClass = 'deadline-warning';
            }

            const isPaid = o['–û–ø–ª–∞—Ç–∞'] === '–î–∞';
            html += `
                <div class="card ${deadlineClass}" onclick="editOrder('${o.ID}')">
                    <div class="card-row"><b>${o['–ù–∏–∫ Instagram']}</b><span class="pay-btn ${isPaid?'pay-done':'pay-wait'}">${isPaid?'‚úÖ –û–ø–ª–∞—á–µ–Ω':'‚è≥ –û–ø–ª–∞—Ç–∞'}</span></div>
                    <div class="card-row"><span>${o['–¢–∏–ø –∏–∑–¥–µ–ª–∏—è']} ‚Ä¢ ${o['–¶–µ–Ω–∞']} BYN</span></div>
                    <div class="card-row" style="margin-top:5px; font-size:11px; color:gray;">
                        <span>${o.–î–µ–¥–ª–∞–π–Ω ? 'üìÖ '+new Date(o.–î–µ–¥–ª–∞–π–Ω).toLocaleDateString() : ''}</span>
                        <span style="color:var(--accent); font-weight:bold;">${o.–°—Ç–∞—Ç—É—Å}</span>
                    </div>
                </div>`;
        });
        document.getElementById('app-content').innerHTML = html || '<div style="text-align:center; padding:50px; color:gray;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        lucide.createIcons();
    }

    function renderClients() {
        const clientsMap = {};
        appData.orders.forEach(o => {
            const nick = o['–ù–∏–∫ Instagram'];
            if (!clientsMap[nick]) clientsMap[nick] = { total: 0, count: 0 };
            clientsMap[nick].total += parseFloat(o.–¶–µ–Ω–∞ || 0);
            clientsMap[nick].count += 1;
        });

        let html = '<div style="padding:10px 15px; font-weight:bold; color:gray;">–í–°–ï–ì–û –ö–õ–ò–ï–ù–¢–û–í: ' + Object.keys(clientsMap).length + '</div>';
        Object.keys(clientsMap).sort((a,b) => clientsMap[b].total - clientsMap[a].total).forEach(nick => {
            html += `
                <div class="client-card">
                    <div class="client-avatar">${nick[0].toUpperCase()}</div>
                    <div style="flex:1">
                        <div style="font-weight:bold;">${nick}</div>
                        <div style="font-size:12px; color:gray;">–ó–∞–∫–∞–∑–æ–≤: ${clientsMap[nick].count}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:bold; color:var(--green);">${clientsMap[nick].total.toFixed(2)}</div>
                        <div style="font-size:10px; color:gray;">BYN</div>
                    </div>
                </div>`;
        });
        document.getElementById('app-content').innerHTML = html;
    }

    function renderCurrentTab() {
        if (!appData) return;
        document.getElementById('totalBalance').innerText = appData.stats.netProfit;
        document.getElementById('search-section').style.display = (currentTab === 'orders') ? 'block' : 'none';

        if (currentTab === 'orders') renderOrders();
        else if (currentTab === 'clients') renderClients();
        // –î—Ä—É–≥–∏–µ —Ç–∞–±—ã...
    }

    function switchTab(tab, el) { 
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        el.classList.add('active');
        currentTab = tab; 
        renderCurrentTab(); 
    }

    function setFilter(f, el) { 
        currentFilter = f; 
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); 
        el.classList.add('active');
        renderOrders(); 
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
    function openModal() { document.getElementById('orderModal').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
    function closeModals() { document.querySelectorAll('.modal-sheet, .overlay').forEach(el => el.classList.remove('active')); }

    init();
</script>
</body>
</html>
