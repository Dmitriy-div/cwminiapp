<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CW Manager Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --bg: #f8f9fb; --accent: #5856d6; --card: #ffffff; --text: #1c1c1e; --secondary: #8e8e93; --radius: 20px; --green: #34c759; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }
        .balance-header { background: #1c1c1e; color: white; margin: 15px; padding: 20px; border-radius: var(--radius); text-align: center; }
        .card { background: var(--card); margin: 12px; padding: 18px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0 25px; border-top: 0.5px solid #eee; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--secondary); font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .input-pill { width: 100%; background: #f2f2f7; border: none; padding: 12px; border-radius: 12px; margin-bottom: 10px; font-size: 15px; outline: none; box-sizing: border-box; }
        .add-btn { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(88,86,214,0.4); z-index: 999; }
        .modal-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 25px 25px 0 0; padding: 20px; transform: translateY(100%); transition: 0.3s ease; z-index: 2000; box-sizing: border-box; max-height: 80vh; overflow-y: auto; }
        .modal-sheet.active { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1999; }
        .overlay.active { opacity: 1; pointer-events: auto; }
        .stat-val { font-size: 18px; font-weight: bold; color: var(--green); }
    </style>
</head>
<body>

    <div class="balance-header">
        <div id="header-label" style="font-size: 12px; opacity: 0.7;">Чистая прибыль</div>
        <div id="main-balance" style="font-size: 24px; font-weight: bold; margin-top:5px;">Загрузка...</div>
    </div>

    <div id="app-content"></div>

    <div class="add-btn" id="mainAddBtn" onclick="openModal()"><i data-lucide="plus"></i></div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orders', this)"><i data-lucide="package"></i><div>Заказы</div></div>
        <div class="nav-item" onclick="switchTab('shipments', this)"><i data-lucide="truck"></i><div>Отправки</div></div>
        <div class="nav-item" onclick="switchTab('shopping', this)"><i data-lucide="shopping-bag"></i><div>Закупки</div></div>
        <div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="pie-chart"></i><div>Бюджет</div></div>
    </nav>

    <div id="overlay" class="overlay" onclick="closeModals()"></div>

    <div id="orderModal" class="modal-sheet">
        <h3>Новый заказ</h3>
        <input type="text" id="ordNick" class="input-pill" placeholder="Ник Instagram">
        <input type="text" id="ordItem" class="input-pill" placeholder="Что заказали?">
        <input type="number" id="ordPrice" class="input-pill" placeholder="Цена (BYN)">
        <button onclick="saveOrder()" style="width:100%; background:var(--accent); color:white; border:none; padding:15px; border-radius:12px;">Добавить</button>
    </div>

    <div id="purchaseModal" class="modal-sheet">
        <h3>Новая закупка</h3>
        <input type="date" id="purDate" class="input-pill">
        <input type="text" id="purType" class="input-pill" placeholder="Что купили? (материалы, реклама...)">
        <input type="number" id="purAmount" class="input-pill" placeholder="Сумма (BYN)">
        <button onclick="savePurchase()" style="width:100%; background:var(--accent); color:white; border:none; padding:15px; border-radius:12px;">Записать расход</button>
    </div>

    <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxeQoWVUnMGMXEv7AIb_ieq_igw2Qnq7i07xOmlrc31tdCLHykwRtuXjXvqOkrZBQB-/exec";
    let currentTab = 'orders';

    function switchTab(tab, el) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        currentTab = tab;
        document.getElementById('mainAddBtn').style.display = (tab === 'stats') ? 'none' : 'flex';
        loadData();
    }

    async function loadData() {
        const cont = document.getElementById('app-content');
        cont.innerHTML = '<div style="text-align:center; padding:40px;">Загрузка...</div>';
        
        const res = await fetch(`${SHEET_URL}?action=getStats`);
        const stats = await res.json();
        document.getElementById('main-balance').innerText = stats.netProfit + ' BYN';

        if(currentTab === 'stats') {
            renderStats(stats);
            return;
        }

        const actionMap = { orders: 'getOrders', shipments: 'getShipments', shopping: 'getPurchases' };
        const dataRes = await fetch(`${SHEET_URL}?action=${actionMap[currentTab]}`);
        const data = await dataRes.json();
        
        if(currentTab === 'shopping') renderPurchases(data);
        else if(currentTab === 'orders') renderOrders(data);
        // ... (renderShipments остается из прошлого кода)
        
        lucide.createIcons();
    }

    function renderPurchases(data) {
        let html = '';
        data.reverse().forEach(p => {
            html += `<div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <b>${p['Тип покупки']}</b>
                    <span style="color:var(--red); font-weight:bold;">-${p['Сумма']} BYN</span>
                </div>
                <div style="font-size:12px; color:gray; margin-top:5px;">${p['Дата']}</div>
            </div>`;
        });
        document.getElementById('app-content').innerHTML = html || '<div style="text-align:center; padding:40px;">Нет закупок</div>';
    }

    function renderStats(stats) {
        document.getElementById('app-content').innerHTML = `
            <div class="card">
                <div style="margin-bottom:10px;">Доход (Заказы - Доставка): <span class="stat-val">${stats.income} BYN</span></div>
                <div style="margin-bottom:10px;">Всего закупок: <span style="color:#ff3b30; font-weight:bold;">${stats.totalPurchases} BYN</span></div>
                <hr style="border:0; border-top:1px solid #eee;">
                <div style="margin-top:10px;">Чистая прибыль: <span class="stat-val" style="font-size:22px;">${stats.netProfit} BYN</span></div>
            </div>
            <div class="card">
                <h4 style="margin-top:0">Популярные изделия</h4>
                <canvas id="typeChart"></canvas>
            </div>
        `;
        
        const ctx = document.getElementById('typeChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats.chartData),
                datasets: [{
                    data: Object.values(stats.chartData),
                    backgroundColor: ['#5856d6', '#34c759', '#ff9500', '#ff3b30', '#af52de']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    }

    function openModal() {
        document.getElementById('overlay').classList.add('active');
        if(currentTab === 'orders') document.getElementById('orderModal').classList.add('active');
        if(currentTab === 'shopping') {
            document.getElementById('purchaseModal').classList.add('active');
            document.getElementById('purDate').valueAsDate = new Date();
        }
    }

    async function savePurchase() {
        const data = {
            action: 'addPurchase',
            date: new Date(document.getElementById('purDate').value).toLocaleDateString('ru-RU'),
            type: document.getElementById('purType').value,
            amount: document.getElementById('purAmount').value
        };
        await sendData(data);
    }

    async function sendData(data) {
        document.getElementById('overlay').click();
        await fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        setTimeout(loadData, 800);
    }

    window.Telegram.WebApp.expand();
    loadData();
</script>
</body>
</html>
