<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CW Master CRM Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f7);
            --text-color: var(--tg-theme-text-color, #1c1c1e);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --accent: var(--tg-theme-button-color, #5856d6);
            --danger: #ff3b30;
            --warning: #ff9500;
            --success: #34c759;
            --radius: 20px;
        }

        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 120px; }
        
        /* Header & Stats */
        .header { background: var(--card-bg); padding: 20px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .balance-val { font-size: 32px; font-weight: 800; text-align: center; margin: 10px 0; color: var(--accent); }
        
        /* Search & Sort Bar */
        .search-container { padding: 10px 20px; display: flex; gap: 10px; }
        .search-input { flex: 1; background: var(--card-bg); border: none; padding: 12px 15px; border-radius: 12px; color: var(--text-color); font-size: 14px; outline: none; }
        .sort-btn { background: var(--card-bg); border: none; padding: 10px; border-radius: 12px; color: var(--hint-color); display: flex; align-items: center; }

        /* Order Cards with Deadline Logic */
        .card { background: var(--card-bg); margin: 0 20px 12px; padding: 16px; border-radius: var(--radius); position: relative; border-left: 5px solid transparent; transition: 0.2s; }
        .card.urgent { border-left-color: var(--danger); background: #fff5f5; } /* –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è */
        .card.upcoming { border-left-color: var(--warning); } /* –°–∫–æ—Ä–æ */
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .nick { font-weight: 700; font-size: 16px; }
        .price { font-weight: 700; color: var(--accent); }
        
        /* Client List Styles */
        .client-row { display: flex; align-items: center; padding: 15px; background: var(--card-bg); margin: 0 20px 8px; border-radius: 15px; gap: 15px; }
        .client-avatar { width: 45px; height: 45px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
        .client-info { flex: 1; }
        .client-stats { font-size: 12px; color: var(--hint-color); }

        /* Navigation */
        .nav-bar { position: fixed; bottom: 20px; left: 15px; right: 15px; background: var(--card-bg); height: 70px; border-radius: 25px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 1000; }
        .nav-item { color: var(--hint-color); display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; text-decoration: none; }
        .nav-item.active { color: var(--accent); }

        .fab { position: fixed; bottom: 105px; right: 20px; width: 56px; height: 56px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: none; z-index: 999; }
        
        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 2000; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-color); width: 100%; padding: 25px; border-radius: 25px 25px 0 0; max-height: 85vh; overflow-y: auto; }
        
        .input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-main { background: var(--accent); color: white; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <select id="monthSelect" onchange="loadData()" style="border:none; background:none; font-weight:bold; color:var(--hint-color);"></select>
            <div id="urgentCounter" style="background:var(--danger); color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:bold; display:none;">üî• 0 –ì–û–†–Ø–¢</div>
        </div>
        <div class="balance-val" id="totalProfit">0.00 BYN</div>
    </div>

    <div id="searchBar" class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É –∏–ª–∏ –∑–∞–∫–∞–∑—É..." oninput="renderOrders()">
        <button class="sort-btn" onclick="toggleSort()"><i data-lucide="arrow-up-down" size="20"></i></button>
    </div>

    <div id="mainContent"></div>

    <button class="fab" onclick="openOrderModal()"><i data-lucide="plus"></i></button>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('orders', this)"><i data-lucide="shopping-cart"></i><span>–ó–∞–∫–∞–∑—ã</span></div>
        <div class="nav-item" onclick="switchTab('clients', this)"><i data-lucide="users"></i><span>–ö–ª–∏–µ–Ω—Ç—ã</span></div>
        <div class="nav-item" onclick="switchTab('stats', this)"><i data-lucide="bar-chart-3"></i><span>–ê–Ω–∞–ª–∏–∑</span></div>
    </nav>

    <div id="orderModal" class="modal" onclick="if(event.target==this) closeModals()">
        <div class="modal-content">
            <h3 id="modalTitle">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
            <input type="hidden" id="orderId">
            <input type="text" id="fNick" class="input" placeholder="–ù–∏–∫ Instagram">
            <input type="text" id="fItem" class="input" placeholder="–ß—Ç–æ –∑–∞–∫–∞–∑—ã–≤–∞—é—Ç?">
            <input type="number" id="fPrice" class="input" placeholder="–¶–µ–Ω–∞ BYN">
            <label style="font-size:12px; color:gray; margin-left:5px;">–î–µ–¥–ª–∞–π–Ω</label>
            <input type="date" id="fDate" class="input">
            <select id="fStatus" class="input">
                <option value="–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</option>
                <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="–ì–æ—Ç–æ–≤">–ì–æ—Ç–æ–≤</option>
            </select>
            <button class="btn btn-main" onclick="saveOrder()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" style="color:var(--danger); margin-top:10px;" id="delBtn" onclick="deleteOrder()">–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxOT8-6WetxBFq-zp22OwZ1QLcCvdLPbV819yK7uQifvMW2-r9EJ6RF_UjOFQDYeGob/exec";
    let appData = { orders: [], purchases: [], shipments: [] };
    let currentTab = 'orders';
    let sortByDeadline = false;

    async function loadData() {
        const res = await fetch(API_URL);
        appData = await res.json();
        if(appData.orders.length > 0 && document.getElementById('monthSelect').innerHTML === "") {
            initMonths();
        }
        renderCurrentTab();
        lucide.createIcons();
    }

    function initMonths() {
        const months = [...new Set(appData.orders.map(o => o.–î–∞—Ç–∞.substring(0, 7)))].sort().reverse();
        const sel = document.getElementById('monthSelect');
        sel.innerHTML = '<option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
    }

    function renderCurrentTab() {
        const cont = document.getElementById('mainContent');
        const search = document.getElementById('searchBar');
        search.style.display = (currentTab === 'orders') ? 'flex' : 'none';

        if(currentTab === 'orders') renderOrders();
        else if(currentTab === 'clients') renderClients();
        else if(currentTab === 'stats') renderStats();
    }

    function renderOrders() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const month = document.getElementById('monthSelect').value;
        let filtered = appData.orders.filter(o => {
            const matchSearch = o['–ù–∏–∫ Instagram'].toLowerCase().includes(query) || o['–¢–∏–ø –∏–∑–¥–µ–ª–∏—è'].toLowerCase().includes(query);
            const matchMonth = month === 'all' || o.–î–∞—Ç–∞.startsWith(month);
            return matchSearch && matchMonth;
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if(sortByDeadline) {
            filtered.sort((a, b) => new Date(a.–î–µ–¥–ª–∞–π–Ω || '9999') - new Date(b.–î–µ–¥–ª–∞–π–Ω || '9999'));
        } else {
            filtered.reverse();
        }

        let html = '';
        let urgentCount = 0;
        const now = new Date();
        now.setHours(0,0,0,0);

        filtered.forEach(o => {
            let deadlineClass = '';
            if(o.–î–µ–¥–ª–∞–π–Ω && o.–°—Ç–∞—Ç—É—Å !== '–ì–æ—Ç–æ–≤') {
                const dDate = new Date(o.–î–µ–¥–ª–∞–π–Ω);
                const diff = (dDate - now) / (1000 * 60 * 60 * 24);
                if(diff <= 0) { deadlineClass = 'urgent'; urgentCount++; }
                else if(diff <= 3) { deadlineClass = 'upcoming'; }
            }

            html += `
                <div class="card ${deadlineClass}" onclick="editOrder('${o.ID}')">
                    <div class="card-header">
                        <span class="nick">${o['–ù–∏–∫ Instagram']}</span>
                        <span class="price">${o.–¶–µ–Ω–∞} BYN</span>
                    </div>
                    <div style="font-size:14px; color:var(--hint-color);">${o['–¢–∏–ø –∏–∑–¥–µ–ª–∏—è']}</div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:11px; background:#eee; padding:3px 8px; border-radius:5px;">${o.–°—Ç–∞—Ç—É—Å}</span>
                        ${o.–î–µ–¥–ª–∞–π–Ω ? `<span style="font-size:11px; color:${deadlineClass==='urgent'?'red':'gray'}">üìÖ ${o.–î–µ–¥–ª–∞–π–Ω.split('T')[0]}</span>` : ''}
                    </div>
                </div>`;
        });

        const counter = document.getElementById('urgentCounter');
        if(urgentCount > 0) { counter.innerText = `üî• ${urgentCount} –ì–û–†–Ø–¢`; counter.style.display = 'block'; }
        else counter.style.display = 'none';

        document.getElementById('mainContent').innerHTML = html || '<p style="text-align:center; color:gray;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
    }

    function renderClients() {
        // –õ–æ–≥–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã (LTV)
        const clients = {};
        appData.orders.forEach(o => {
            const nick = o['–ù–∏–∫ Instagram'];
            if(!clients[nick]) clients[nick] = { count: 0, total: 0 };
            clients[nick].count++;
            clients[nick].total += parseFloat(o.–¶–µ–Ω–∞ || 0);
        });

        let html = '<h3 style="margin:20px;">–ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã</h3>';
        Object.keys(clients).sort((a,b) => clients[b].total - clients[a].total).forEach(nick => {
            html += `
                <div class="client-row">
                    <div class="client-avatar">${nick[0].toUpperCase()}</div>
                    <div class="client-info">
                        <div style="font-weight:bold;">${nick}</div>
                        <div class="client-stats">–ó–∞–∫–∞–∑–æ–≤: ${clients[nick].count}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--success);">${clients[nick].total.toFixed(2)}</div>
                        <div style="font-size:10px; color:gray;">–í—Å–µ–≥–æ BYN</div>
                    </div>
                </div>`;
        });
        document.getElementById('mainContent').innerHTML = html;
    }

    function renderStats() {
        document.getElementById('mainContent').innerHTML = `
            <div style="padding:20px;">
                <canvas id="statChart" width="400" height="400"></canvas>
            </div>
        `;
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å Chart.js –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    }

    function switchTab(tab, el) {
        currentTab = tab;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        renderCurrentTab();
    }

    function toggleSort() {
        sortByDeadline = !sortByDeadline;
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        renderOrders();
    }

    // Modal Logic
    function openOrderModal() {
        document.getElementById('orderId').value = "";
        document.getElementById('fNick').value = "";
        document.getElementById('delBtn').style.display = "none";
        document.getElementById('orderModal').classList.add('active');
    }

    function editOrder(id) {
        const o = appData.orders.find(x => x.ID == id);
        document.getElementById('orderId').value = o.ID;
        document.getElementById('fNick').value = o['–ù–∏–∫ Instagram'];
        document.getElementById('fItem').value = o['–¢–∏–ø –∏–∑–¥–µ–ª–∏—è'];
        document.getElementById('fPrice').value = o.–¶–µ–Ω–∞;
        document.getElementById('fDate').value = o.–î–µ–¥–ª–∞–π–Ω ? o.–î–µ–¥–ª–∞–π–Ω.split('T')[0] : "";
        document.getElementById('fStatus').value = o.–°—Ç–∞—Ç—É—Å;
        document.getElementById('delBtn').style.display = "block";
        document.getElementById('orderModal').classList.add('active');
    }

    function closeModals() {
        document.getElementById('orderModal').classList.remove('active');
    }

    async function saveOrder() {
        const data = {
            action: document.getElementById('orderId').value ? 'editEntry' : 'addOrder',
            sheet: 'Orders',
            id: document.getElementById('orderId').value,
            nick: document.getElementById('fNick').value,
            item: document.getElementById('fItem').value,
            price: document.getElementById('fPrice').value,
            deadline: document.getElementById('fDate').value,
            status: document.getElementById('fStatus').value
        };
        closeModals();
        window.Telegram.WebApp.MainButton.showProgress();
        await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
        loadData();
    }

    window.onload = init;
    function init() {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        loadData();
    }
</script>
</body>
</html>
